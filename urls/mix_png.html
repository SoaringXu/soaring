<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>ç‚¹å‡»å°±å˜å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="../css/index-bar.css" type="text/css">
    <style type="text/css">
        body {
            line-height: 1.5;
            background: var(--primary-color);
            transition: background-color 0.5s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        p {
            color: white;
            max-width: 500px;
            padding: 5px 20px;
        }

        img {
            max-width: 400px;
            height: auto;
            margin: 50px;
        }

        #output-container {
            position: fixed;
            top: 500px;
            max-width: 500px;
            width: 500px;
        }
    </style>
</head>

<body>
    <div class="top-nav-bar"></div>
    <nav class="top-nav">
        <a href="../index.html" class="nav-logo">ğŸŒŸ æ˜Ÿä¹‹å½¼å²¸</a>
        <div class="nav-links">
            <a href="../index.html" class="nav-link">é¦–é¡µ</a>
            <a href="../main.html" class="nav-link">åƒå–ç©ä¹</a>
        </div>
    </nav>
    <div>
    <p>
        é€‰æ‹©å›¾ç‰‡ï¼Œç‚¹å‡»ç”Ÿæˆï¼Œå³é”®ä¿å­˜ã€‚<br />
        Chose images, chick "Create" button, save image by right-click.
    </p>
    <p>
        ç”Ÿæˆçš„å›¾ç‰‡å°ºå¯¸æ˜¯å›¾ç‰‡1çš„å°ºå¯¸ã€‚<br />
        The size of created image is same as Image 1.
    </p>

    <p>
        <label>
            å›¾ç‰‡1ï¼ˆè¾ƒäº®ï¼‰/ Image 1 (light)ï¼š<br />
            <input id="input1" type="file" accept="image" onchange="load1()">
        </label>
    </p>
    <p>
        <label>
            å›¾ç‰‡2ï¼ˆè¾ƒæš—ï¼‰/ Image 2 (dark)ï¼š<br />
            <input id="input2" type="file" accept="image" onchange="load2()">
        </label>
    </p>

    <p>
        <button onclick="run()"> ç”Ÿæˆ / Create </button>
        <button onclick="toggle()"> åˆ‡æ¢èƒŒæ™¯é¢œè‰² / Toggle background color </button>
    </p>

    <div id="output-container">
        <img id="output" onclick="toggle()" />
    </div>
    </div>

    <script type="text/javascript">

        var img1 = document.createElement('img')
        var img2 = document.createElement('img')

        function load1() {
            var reader = new FileReader()
            reader.onload = function () {
                img1.src = reader.result
            }
            reader.readAsDataURL(input1.files[0])
        }
        function load2() {
            var reader = new FileReader()
            reader.onload = function () {
                img2.src = reader.result
            }
            reader.readAsDataURL(input2.files[0])
        }

        function run() {
            // create context
            var c = document.createElement('canvas')
            c.width = img1.width
            c.height = img1.height
            var ctx = c.getContext("2d")

            // get data
            ctx.drawImage(img1, 0, 0)
            var data1 = ctx.getImageData(0, 0, c.width, c.height) //ä¸€ç»´æ•°ç»„
            ctx.drawImage(img2, 0, 0, c.width, c.height)
            var data2 = ctx.getImageData(0, 0, c.width, c.height)
            // create blank data
            var data3 = ctx.createImageData(c.width, c.height)

            // process
            var i = 0
            var len = data1.data.length

            var R1, G1, B1, avg1 // light
            var R2, G2, B2, avg2 // dark
            var R3, G3, B3, A3 // output, A is alpha

            var delta = 25
            for (; i < len; i += 4) {
                // oho, interval questionï¼Œ0~255 or 0~1?
                R1 = data1.data[i + 0] + delta // 0~255
                G1 = data1.data[i + 1] + delta // 0~255
                B1 = data1.data[i + 2] + delta // 0~255
                avg1 = (R1 + G1 + B1) / 3 // 0~255

                R2 = data2.data[i + 0] - delta
                G2 = data2.data[i + 1] - delta
                B2 = data2.data[i + 2] - delta
                avg2 = (R2 + G2 + B2) / 3

                A3 = avg2 - avg1 + 255 // 0~255
                if (A3 === 0) {
                    A3 = 0.0001
                }
                R3 = R2 * 255 / A3 // equal to R2 / A3 * 255
                G3 = G2 * 255 / A3
                B3 = B2 * 255 / A3

                data3.data[i + 0] = R3
                data3.data[i + 1] = G3
                data3.data[i + 2] = B3
                data3.data[i + 3] = A3
            }

            // save
            ctx.putImageData(data3, 0, 0)
            output.src = c.toDataURL("image/png")
        }


        var black = false

        function toggle() {
            if (black) {
                document.getElementById("output-container").style.backgroundColor = "#FFF"
            } else {
                document.getElementById("output-container").style.backgroundColor = "#000"
            }
            black = !black
        }
    </script>
</body>
</html>
